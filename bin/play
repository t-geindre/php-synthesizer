#!/usr/bin/env php
<?php
require(__DIR__.'/../vendor/autoload.php');

use Synthesizer\Automation\Automation;
use Synthesizer\Generator\Stack;
use Synthesizer\Input\Track;
use Synthesizer\Output\Wav;

function error($msg) : void
{
    $stderr = fopen('php://stderr', 'w');
    fwrite($stderr, $msg."\n");
    fclose($stderr);
    exit(1);
}

if ($argc !== 2) {
    error('Please provide song to play as first argument');
}

if (!file_exists($songFile = __DIR__.'/songs/'.strtolower($argv[1]).'.php')) {
    error(sprintf('Unknown song %s', $argv[1]));
}

$output = new Wav();
$clock = $output->getClock();
$automation = new Automation($clock);

$arranger = new Stack();
array_map(
    fn(Track $track) => $arranger->push($track),
    require($songFile)
);

try {
    while(!$arranger->isOver() || !$automation->isOver()) {
        $automation->update();
        $output->addSample($arranger->getValue());
    }
} catch (\InvalidArgumentException $e) {
    error($e->getMessage());
}
